#!/bin/bash

if [[ $EUID -eq 0 ]]; then
   echo "YOU ALMOST BROKE YOU ENTIRE BACKUP SYSTEM!!! DONT RUN AS ROOT" 
   exit 80085
fi

current_date=$(date +"%d-%m-%y-%H-%M")

pacy # Updates pac.txt so that All pacman files are the ones currently in use

backup_scripts # Updates the files in the github repo full of shell scripts and conf with the ones currently in use

# Check if mount was successful
if [ $? -ne 0 ]; then
    echo "Failed to mount /mnt/backup. Exiting..."
    exit 1
fi

echo "Backup started at $current_date"

exclude="--exclude */node_modules"

cd ~/Documents

borg prune --force --force --stats --list --keep-within 2d -d 31 -w 8 -m 12 -y 2 --save-space /mnt/backup

borg create --progress --stats --show-rc --verbose --compression lz4  /mnt/backup::Jacksons-Laptop-'{now}' ~/Documents

borg compact /mnt/backup

# Check if unmount was successful
if [ $? -ne 0 ]; then
    echo "Failed to unmount /mnt/backup. Please check if any processes are still using it."
    exit 1
fi

echo "Backup finished"
